name: Update UUP Data

on:
  schedule:
    - cron: '0 */2 * * *' # Her 2 saatte bir çalışır

jobs:
  update_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install axios

      - name: Fetch and update data
        run: |
          node <<EOF
          const axios = require('axios');
          const fs = require('fs');

          const UUP_TABLE = [
              { "UpdateID": "ad27e52b-9e18-408a-9df2-8688e5273fbf", "Version": "W11 24H2", "Arch": "x64", "IsWin11": true },
              { "UpdateID": "b6049aaf-4f56-4183-8e58-32954906de64", "Version": "W11 24H2", "Arch": "arm64", "IsWin11": true },
              { "UpdateID": "30da46b4-2ff2-4682-a9ae-23b66dd98713", "Version": "W11 Server version 24H2", "Arch": "x64", "IsWin11": true },
              { "UpdateID": "fb12fdae-dd42-4d2d-b8cc-380a968e8d10", "Version": "W11 Server version 24H2", "Arch": "arm64", "IsWin11": true },
              { "UpdateID": "ebf14a71-0f6e-4958-9bf4-27c746050640", "Version": "W11 Server version 23H2", "Arch": "x64", "IsWin11": true },
              { "UpdateID": "9310ebcc-79ee-40aa-ae4a-4da849dd4684", "Version": "W10 Server version 22H2", "Arch": "x64", "IsWin11": false },
              { "UpdateID": "2ba1d737-a36b-415b-a630-85bd5146d77d", "Version": "W10 Server version 21H2", "Arch": "x64", "IsWin11": false },
              { "UpdateID": "0c36c0e6-8397-424d-b460-26cc0d044c7f", "Version": "W11 22H2 & 23H2", "Arch": "x64", "IsWin11": true },
              { "UpdateID": "a2b2e765-4612-44d8-9fb0-b11b699aaf4b", "Version": "W11 22H2 & 23H2", "Arch": "arm64", "IsWin11": true },
              { "UpdateID": "35630b7b-4509-45b6-83a1-d4c75d5aa9b6", "Version": "W11 21H2", "Arch": "x64", "IsWin11": true },
              { "UpdateID": "fba7e852-3fcc-4dad-8561-42c455cfffd7", "Version": "W11 21H2", "Arch": "arm64", "IsWin11": true },
              { "UpdateID": "e1885854-aea0-453d-9e64-bfd00535a925", "Version": "W10 22H2", "Arch": "x64", "IsWin11": false },
              { "UpdateID": "21dec2dc-8213-4021-a31c-7dd07e034dd5", "Version": "W10 22H2", "Arch": "x86", "IsWin11": false },
              { "UpdateID": "d1aaf6a7-c80b-49bb-8d79-99b6a3cfb5c1", "Version": "W10 22H2", "Arch": "arm64", "IsWin11": false },
              { "UpdateID": "3ead9b43-aa9d-4973-8195-24be0b0ce1e1", "Version": "W10 2004, 20H2, 21H1, 21H2", "Arch": "x64", "IsWin11": false },
              { "UpdateID": "70f4293c-6eaa-4db5-b059-9755ab5628d8", "Version": "W10 2004, 20H2, 21H1, 21H2", "Arch": "x86", "IsWin11": false },
              { "UpdateID": "bb720c43-af68-4dc6-a397-42f278183314", "Version": "W10 2004, 20H2, 21H1, 21H2", "Arch": "arm64", "IsWin11": false },
              { "UpdateID": "9005d4cd-fce9-466b-b98e-a67414acebd8", "Version": "W10 1809", "Arch": "x64", "IsWin11": false },
              { "UpdateID": "dcb2f7dd-8822-444b-802f-d417e19474a9", "Version": "W10 1809", "Arch": "x86", "IsWin11": false },
              { "UpdateID": "5a143235-5474-4cfa-9078-65e434d9df67", "Version": "W10 1809", "Arch": "arm64", "IsWin11": false }
          ];

          const REGION_TABLE = [
              { "Region": "ar-sa", "Language": "Arabic" },
              { "Region": "bg-bg", "Language": "Bulgarian" },
              { "Region": "cs-cz", "Language": "Czech" },
              { "Region": "da-dk", "Language": "Danish" },
              { "Region": "de-de", "Language": "German" },
              { "Region": "el-gr", "Language": "Greek" },
              { "Region": "en-gb", "Language": "English (United Kingdom)" },
              { "Region": "en-us", "Language": "English (United States)" },
              { "Region": "es-es", "Language": "Spanish" },
              { "Region": "es-mx", "Language": "Spanish (Mexico)" },
              { "Region": "et-ee", "Language": "Estonian" },
              { "Region": "fi-fi", "Language": "Finnish" },
              { "Region": "fr-ca", "Language": "French (Canada)" },
              { "Region": "fr-fr", "Language": "French" },
              { "Region": "he-il", "Language": "Hebrew" },
              { "Region": "hr-hr", "Language": "Croatian" },
              { "Region": "hu-hu", "Language": "Hungarian" },
              { "Region": "it-it", "Language": "Italian" },
              { "Region": "ja-jp", "Language": "Japanese" },
              { "Region": "ko-kr", "Language": "Korean" },
              { "Region": "lt-lt", "Language": "Lithuanian" },
              { "Region": "lv-lv", "Language": "Latvian" },
              { "Region": "nb-no", "Language": "Norwegian" },
              { "Region": "nl-nl", "Language": "Dutch" },
              { "Region": "pl-pl", "Language": "Polish" },
              { "Region": "pt-br", "Language": "Portuguese (Brazil)" },
              { "Region": "pt-pt", "Language": "Portuguese" },
              { "Region": "ro-ro", "Language": "Romanian" },
              { "Region": "ru-ru", "Language": "Russian" },
              { "Region": "sk-sk", "Language": "Slovak" },
              { "Region": "sl-si", "Language": "Slovenian" },
              { "Region": "sr-latn-rs", "Language": "Serbian (Latin)" },
              { "Region": "sv-se", "Language": "Swedish" },
              { "Region": "th-th", "Language": "Thai" },
              { "Region": "tr-tr", "Language": "Turkish" },
              { "Region": "uk-ua", "Language": "Ukrainian" },
              { "Region": "zh-cn", "Language": "Chinese (Simplified)" },
              { "Region": "zh-tw", "Language": "Chinese (Traditional)" }
          ];
          
          const SERVER_FOD_KEYWORDS = [
             'Microsoft-Windows-LanguageFeatures-Basic',
             'Microsoft-Windows-LanguageFeatures-OCR',
             'Microsoft-Windows-LanguageFeatures-TextToSpeech',
             'Microsoft-Windows-Client-LanguagePack',
             'Microsoft-AzureStack-HCI-Management-Tools-FOD-Package',
             'Microsoft-OneCore-StorageManagement-FoD-Package',
             'Microsoft-Windows-ActiveDirectory-DS-LDS-Tools-FoD-Package',
             'Microsoft-Windows-BitLocker-Recovery-Tools-FoD-Package',
             'Microsoft-Windows-CertificateServices-Tools-FoD-Package',
             'Microsoft-Windows-Console-Host-Legacy-FoD-Package',
             'Microsoft-Windows-DHCP-Tools-FoD-Package',
             'Microsoft-Windows-DNS-Tools-FoD-Package',
             'Microsoft-Windows-EMS-SAC-Desktop-Tools-FoD-Package',
             'Microsoft-Windows-FailoverCluster-Management-Tools-FOD-Package',
             'Microsoft-Windows-FileServices-Tools-FoD-Package',
             'Microsoft-Windows-GroupPolicy-Management-Tools-FoD-Package',
             'Microsoft-Windows-IPAM-Client-FoD-Package',
             'Microsoft-Windows-IRDA-Package',
             'Microsoft-Windows-NetworkController-Tools-FoD-Package',
             'Microsoft-Windows-NetworkLoadBalancing-Tools-FoD-Package',
             'Microsoft-Windows-RasCMAK-Client-Package',
             'Microsoft-Windows-RasRip-Package',
             'Microsoft-Windows-RemoteAccess-Management-Tools-FoD-Package',
             'Microsoft-Windows-RemoteDesktop-Services-Tools-FoD-Package',
             'Microsoft-Windows-Server-AppCompat-FoD-Package',
             'Microsoft-Windows-ServerCoreFonts-NonCritical-Fonts-BitmapFonts-FOD-Package',
             'Microsoft-Windows-ServerCoreFonts-NonCritical-Fonts-MinConsoleFonts-FOD-Package',
             'Microsoft-Windows-ServerCoreFonts-NonCritical-Fonts-Support-FOD-Package',
             'Microsoft-Windows-ServerCoreFonts-NonCritical-Fonts-TrueType-FOD-Package',
             'Microsoft-Windows-ServerCoreFonts-NonCritical-Fonts-UAPFonts-FOD-Package',
             'Microsoft-Windows-ServerManager-Tools-FoD-Package',
             'Microsoft-Windows-SNMP-Client-Package',
             'Microsoft-Windows-StorageManagement-FoD-Package',
             'Microsoft-Windows-StorageMigrationService-Management-Tools-FOD-Package',
             'Microsoft-Windows-StorageReplica-Tools-FoD-Package',
             'Microsoft-Windows-SystemInsights-Management-Tools-FOD-Package',
             'Microsoft-Windows-TPM-Diagnostics-FOD-Package',
             'Microsoft-Windows-VolumeActivation-Tools-FoD-Package',
             'Microsoft-Windows-Shielded-VM-Tools-FoD-Package',
             'Microsoft-Windows-WMI-SNMP-Provider-Client-Package',
             'Microsoft-OneCore-DeveloperMode-Desktop-Package',
             'microsoft-windows-composition-test-fod-package',
             'microsoft-windows-ipam-client-fod-package',
             'microsoft-windows-irda-package',
             'microsoft-windows-systeminsights-management-tools-fod-package',
             'microsoft-windows-wmi-snmp-provider-client-package',
             'microsoft-windows-media-features-package',
              'Microsoft-Windows-WSUS-Tools-FoD-Package'
          ];
          
          function isServerFOD(fileName, language) {
            const locale = language.replace(/-$/, '');
            for (const keyword of SERVER_FOD_KEYWORDS) {
                if (fileName.match(new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + `.*${locale}\\.cab$`))) {
                    return true;
                }
            }
            return false;
        }

          function isValidFileType(fileName, language) {
             return (fileName.match(/\.(esd|cab)$/) && fileName.match(language)) ||
                fileName.match(/LanguageExperiencePack_.*\.appx$/);
          }
          
          function filterWindowsFiles(file, language, hideServerFODs) {
                if (!isValidFileType(file.name, language)) {
                    return false;
                 }
                
                if (hideServerFODs && isServerFOD(file.name, language)) {
                    return false;
                 }

                 if (
                     file.name.match(/core_.*\.esd$/) ||
                     file.name.match(/professional_.*\.esd$/) ||
                     file.name.match(/coren_.*\.esd$/) ||
                     file.name.match(/professionaln_.*\.esd$/) ||
                     file.name.match(/PPIPro_.*\.esd$/) ||
                     file.name.match(/ServerDatacenter_.*\.esd$/) ||
                     file.name.match(/ServerStandard_.*\.esd$/) ||
                     file.name.match(/ServerTurbine_.*\.esd$/)
                ) {
                   return false;
                }
              
              const alwaysHideCABFilesPatterns = [
                     'amd64_Microsoft-Windows-LanguageFeatures-Basic-.*-Package_.*\\.cab',
                    'amd64_Microsoft-Windows-LanguageFeatures-Handwriting-.*-Package_.*\\.cab',
                     'amd64_Microsoft-Windows-LanguageFeatures-OCR-.*-Package_.*\\.cab',
                     'amd64_Microsoft-Windows-LanguageFeatures-TextToSpeech-.*-Package_.*\\.cab',
                     'amd64_Microsoft-OneCore-DeveloperMode-Desktop-Package_.*\\.cab',
                     'amd64_Microsoft-Windows-LanguageFeatures-Speech-.*-Package_.*\\.cab',
                     'Microsoft-AzureStack-HCI-Management-Tools-FOD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-OneCore-StorageManagement-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-OneCore-StorageManagement-FoD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-ActiveDirectory-DS-LDS-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-ActiveDirectory-DS-LDS-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                     'Microsoft-Windows-BitLocker-Recovery-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-CertificateServices-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Composition-Test-FOD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Composition-Test-FOD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-DHCP-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-DHCP-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-DNS-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-DNS-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-EMS-SAC-Desktop-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-FailoverCluster-Management-Tools-FOD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-FailoverCluster-Management-Tools-FOD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-FileServices-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-FileServices-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-GroupPolicy-Management-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-GroupPolicy-Management-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                     'Microsoft-Windows-InternetExplorer-Optional-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-IPAM-Client-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-IPAM-Client-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-IRDA-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-IRDA-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-LanguageFeatures-Basic-.*-Package-amd64_.*\\.cab',
                    'Microsoft-Windows-LanguageFeatures-Handwriting-.*-Package-amd64\\.cab',
                    'Microsoft-Windows-LanguageFeatures-Handwriting-.*-Package-amd64_.*\\.cab',
                    'Microsoft-Windows-LanguageFeatures-OCR-.*-Package-amd64_.*\\.cab',
                    'Microsoft-Windows-LanguageFeatures-TextToSpeech-.*-Package-amd64_.*\\.cab',
                   'Microsoft-Windows-Media-Features-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-Media-Features-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-MSPaint-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-MSPaint-FoD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-NetworkController-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-NetworkLoadBalancing-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Notepad-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Notepad-FoD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Notepad-System-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Notepad-System-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-PowerShell-ISE-FOD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-PowerShell-ISE-FOD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Printing-PMCPPC-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Printing-WFS-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-RasCMAK-Client-Package-amd64-.*-.*_.*\\.cab',
                     'Microsoft-Windows-RasCMAK-Client-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-RasRip-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-RemoteAccess-Management-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-RemoteAccess-Management-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-RemoteDesktop-Services-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-Server-AppCompat-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-ServerManager-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-ServerManager-Tools-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-SnippingTool-FoD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-SNMP-Client-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-SNMP-Client-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-StepsRecorder-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-StepsRecorder-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-StorageManagement-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-StorageManagement-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-StorageMigrationService-Management-Tools-FOD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-StorageReplica-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                  'Microsoft-Windows-StorageReplica-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-SystemInsights-Management-Tools-FOD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-TPM-Diagnostics-FOD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-TPM-Diagnostics-FOD-Package-wow64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-VolumeActivation-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-WirelessDisplay-FOD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-WMI-SNMP-Provider-Client-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-Windows-WMI-SNMP-Provider-Client-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-WordPad-FoD-Package-amd64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-WordPad-FoD-Package-wow64-.*-.*_.*\\.cab',
                   'Microsoft-Windows-WSUS-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                    'Microsoft-OneCore-DeveloperMode-Desktop-Package-amd64_.*\\.cab',
                    'Microsoft-Windows-Shielded-VM-Tools-FoD-Package-amd64-.*-.*_.*\\.cab',
                  'Microsoft-Windows-LanguageFeatures-Speech-.*-Package-amd64_.*\\.cab'
                ];

               for (const pattern of alwaysHideCABFilesPatterns) {
                 if (file.name.match(new RegExp(pattern))) {
                        return false;
                    }
              }
              
               return true;
           }
          
          async function fetchUUPData(updateId, language) {
                try {
                  let apiUrl = `https://api.uupdump.net/get.php?id=${updateId}`;
                  if (language) {
                    apiUrl += `&lang=${language}`;
                   }
                 const response = await axios.get(apiUrl);
                  if (response.data.error) {
                       console.error(`API Error: ${response.data.error}`);
                       return null;
                    }
                 return response.data;
              } catch (error) {
                  console.error("API Request failed:", error);
                 return null;
              }
           }
          
          async function main() {
            const allData = {};
            
            for (const entry of UUP_TABLE) {
              const { UpdateID, Version, Arch, IsWin11 } = entry;
              allData[Version] = allData[Version] || {};
              allData[Version][Arch] = allData[Version][Arch] || {};
          
              for (const langEntry of REGION_TABLE) {
                  const { Region, Language } = langEntry;
                  const apiResponse = await fetchUUPData(UpdateID, Region);
                  if(apiResponse && apiResponse.response && apiResponse.response.files){
                      const filteredFiles = Object.values(apiResponse.response.files)
                        .filter(file => filterWindowsFiles(file, Region, true))
                      
                       allData[Version][Arch][Region] = filteredFiles.map(file => ({
                         name: file.name,
                         size: file.size,
                        url: file.url,
                    }));
                     } else{
                        allData[Version][Arch][Region] = null;
                     }
                 }
             }
            
            fs.writeFileSync('./data/uup_data.json', JSON.stringify(allData, null, 2));
          }
            
          main();
          EOF
      
      - name: Commit and push changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add data/uup_data.json
          git commit -m "Update UUP data"
          git push